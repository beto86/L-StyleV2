{% extends 'modelo.html' %}

{% load static %}
{% load filtros %}

{% block titulo %}
<title>Relatório</title>
{% endblock %}

{% block conteudo %}

<div class="relatorio">
    <h3 class="title border-custom-primary">Pagina de Relatórios</h3>
    <div class="box">
        
        <div class="left">
            {% if curso %}
            <h3>Testes aplicados no curso: {{ curso }} </h3>

            <ul>
                {% for teste in testes %}
                <li>
                    #{{ teste.pk }} - {{ teste }}
                </li>
                {% empty %}
                <li>Nenhum teste aplicado nesse curso</li>
                {% endfor %}
            </ul>
                
                {% else %}
            <h4>Selecione um curso para consultar...</h4>
            {% endif %}
        </div>

        <div class="right">
            <div class="tabMenu">
                <h1 class="btnRelNav active" style="border-bottom-color: #ffcc44;" data-role="sortByTurma">Tentativas do Curso</h1>           
            </div>
            <form action="" method="GET" class="formulario" id="cursoForm">
                <label for="cursos">Escolha um Curso:</label>


                <select name="cursos" id="cursos">
                    {% for c in cursos %}
                    <option value="{{ c.pk }}">{{ c }}</option>
                    {% endfor %}
                </select>
                <input type = 'submit' value="Enviar" class="btn">
            </form>
            
        </div>
    </div>
</div>

<br>

<!-- Para cada teste gera um gráfico diferente com o id mediaCurso_1, por exemplo -->
{% for teste in testes %}
<hr>
<div class="row shadow-sm m-4 p-4">
    <div class="col-lg-4">
        <canvas id="mediaCurso_{{teste.pk}}" style="max-width: 500px;"></canvas>
    </div>
    <div class="col-lg">
        
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Usuário</th>
                    <th>Estilo</th>
                    <th>Data</th>
                </tr>
            </thead>
            <tbody>
                {% with dados=mediaCurso|get_dict_pos:teste.pk %}
                    {% for tent in dados|get_dict_pos:'tentativas' %}
                    <tr>
                        <td>{{ tent.usuario|default_if_none:'Anônimo' }}</td>
                        <td>{{ tent.estilo|default_if_none:'Não definido' }}</td>
                        <td>{{ tent.data }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="100%">
                            Nenhuma resposta registrada para esse teste.
                        </td>
                    </tr>
                    {% endfor %}
                {% endwith %}
            </tbody>
        </table>

    </div>
</div>
<!-- <canvas id="mediaPorCurso" style="display: none;"></canvas> -->
{% endfor %}

{% if curso %}
<br>
<br>
<hr class="mt-5 mb-3">

<canvas id="evolucaoCurso" style="max-width: 600px; max-height: 600px;"></canvas>



{% endif %}

{% endblock %}

{% block scripts %}

<script src="{% static 'js/Chart.min.js' %}"></script>
<script src="{% static 'js/relatorio.js' %}"></script>
<script>
    $(document).ready(function () {

        // ##########################################
        // Monta um gráfico daquele para cada teste do curso

        {% for teste in testes %}
        //relatório para a media do curso de estilo de aprendizagem
        var ctx = $('#mediaCurso_{{teste.pk}}');

        {% with contagem=mediaCurso|get_dict_pos:teste.pk %}
        var dados = {
            labels: ['Assimilador', 'Convergente', 'Divergente', 'Acomodador'],
            datasets: [
                { // Depois os dados/média do curso
                    label: 'Geral do Curso',
                    data: [
                        {{ contagem|get_dict_pos:'Assimilador' }}, 
                        {{ contagem| get_dict_pos:'Convergente' }}, 
                        {{ contagem| get_dict_pos:'Divergente' }}, 
                        {{ contagem| get_dict_pos:'Acomodador' }}
                    ],
                    fill: true,
                    backgroundColor: [
                    'rgba(255, 99, 132, 0.3)',
                    'rgba(54, 162, 235, 0.3)',
                    'rgba(255, 206, 86, 0.3)',
                    'rgba(0, 255, 0, 0.3)',
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(0, 255, 0, 1)',
                    ],
                    borderWidth: 1
                }
            ] // fim dos conjuntos
        };
        {% endwith %}

        var config = {
            maintainAspectRatio: true,
            title: {
                display: true,
                text: 'Resultados do Teste #{{teste.pk}}',
                fontSize: 30,
                fontColor: '#273c75'
            },
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true,
                        stepSize: 1
                    }
                }]
            },
        };

        var myChart = new Chart(ctx, {
            type: 'bar',
            data: dados,
            options: config,
        });


        {% endfor %}
        // Fim dos gráficos para cada teste do curso
        // ##########################################

        
       
        //Relatório por curso contendo a evolução do curso, gráfico de linha
        var ctx = $('#evolucaoCurso');

        var dados = {
            labels: ['Jan', 'Fev', 
                    'Mar', 'Abr', 
                    'Maio', 'Jun', 
                    'Jul', 'Ago', 
                    'Set', 'Out', 
                    'Nov', 'Dez'
                ],
            datasets: [
                { 
                    label: 'Assimilador',
                    data: [{{curAssJan}}, {{curAssFev}}, 
                            {{curAssMar}}, {{curAssAbr}}, 
                            {{curAssMai}}, {{curAssJun}}, 
                            {{curAssJul}}, {{curAssAgo}}, 
                            {{curAssSet}}, {{curAssOut}}, 
                            {{curAssNov}}, {{curAssDez}}
                        ],
                    fill: false,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 3,
                    backgroundColor: 'transparent',
                },
                { 
                    label: 'Convergente',
                    data: [{{curConJan}}, {{curConFev}}, 
                            {{curConMar}}, {{curConAbr}}, 
                            {{curConMai}}, {{curConJun}}, 
                            {{curConJul}}, {{curConAgo}}, 
                            {{curConSet}}, {{curConOut}}, 
                            {{curConNov}}, {{curConDez}}
                        ],
                    fill: false,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 3,
                    backgroundColor: 'transparent',
                },
                { 
                    label: 'Divergente',
                    data: [{{curDivJan}}, {{curDivFev}}, 
                            {{curDivMar}}, {{curDivAbr}}, 
                            {{curDivMai}}, {{curDivJun}}, 
                            {{curDivJul}}, {{curDivAgo}}, 
                            {{curDivSet}}, {{curDivOut}}, 
                            {{curDivNov}}, {{curDivDez}}
                        ],
                    fill: false,
                    borderColor: 'rgba(255, 206, 86, 1)',
                    borderWidth: 3,
                    backgroundColor: 'transparent',
                },
                { 
                    label: 'Acomodador',
                    data: [{{curAcoJan}}, {{curAcoFev}}, 
                            {{curAcoMar}}, {{curAcoAbr}}, 
                            {{curAcoMai}}, {{curAcoJun}}, 
                            {{curAcoJul}}, {{curAcoAgo}}, 
                            {{curAcoSet}}, {{curAcoOut}}, 
                            {{curAcoNov}}, {{curAcoDez}}
                        ],
                    fill: false,
                    borderColor: 'rgba(0, 255, 0, 1)',
                    borderWidth: 3,
                    backgroundColor: 'transparent',
                },
            ] // fim dos conjuntos
        };

        var config3 = {
            maintainAspectRatio: true,
            title: {
                display: true,
                text: 'Evolução do Curso',
                fontSize: 30,
                fontColor: '#273c75'
            },
            elements: {
                line: {
                    tension:0
                }
            },
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true,
                        stepSize: 1
                    }
                }]
            },
        };

        var ChartCursoEvl = new Chart(ctx, {
            type: 'line',
            data: dados,
            options: config3,
        });
    });

</script>

{% endblock %}